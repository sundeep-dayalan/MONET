name: Release MONET Platform
on:
  push:
    tags: ['v*']

jobs:
  build-and-release:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      
      - name: Setup Node.js & pnpm
        uses: actions/setup-node@v3
        with:
          node-version: '20'
      - run: npm install -g pnpm
      
      - name: Install dependencies
        run: pnpm install
        
      - name: Build packages
        run: pnpm build
          
      - name: Create deployment packages
        run: |
          mkdir -p releases
          
          # Frontend package
          echo "Creating frontend package..."
          cd packages/client
          mkdir -p ../../releases/frontend-deploy
          cp -r dist/* ../../releases/frontend-deploy/
          cd ../../releases/frontend-deploy
          cat > web.config << 'EOF'
          <?xml version="1.0" encoding="utf-8"?>
          <configuration>
            <system.webServer>
              <rewrite>
                <rules>
                  <rule name="Handle History Mode" stopProcessing="true">
                    <match url="(.*)" />
                    <conditions logicalGrouping="MatchAll">
                      <add input="{REQUEST_FILENAME}" matchType="IsFile" negate="true" />
                      <add input="{REQUEST_FILENAME}" matchType="IsDirectory" negate="true" />
                    </conditions>
                    <action type="Rewrite" url="/" />
                  </rule>
                </rules>
              </rewrite>
            </system.webServer>
          </configuration>
          EOF
          zip -r ../monet-frontend.zip .
          cd ../..
          
          # Backend package - Azure Functions
          echo "Creating backend package..."
          cd packages/core
          mkdir -p ../../releases/api-deploy
          
          # Copy all compiled files to deployment directory
          cp -r dist/* ../../releases/api-deploy/
          cp package.json ../../releases/api-deploy/
          
          cd ../../releases/api-deploy
          
          # Install production dependencies
          npm install --production
          
          # Create host.json
          cat > host.json << 'EOF'
          {
            "version": "2.0",
            "extensionBundle": {
              "id": "Microsoft.Azure.Functions.ExtensionBundle",
              "version": "[4.*, 5.0.0)"
            },
            "functionTimeout": "00:05:00",
            "http": {
              "routePrefix": ""
            }
          }
          EOF
          
          # CRITICAL: Create the function directory and function.json
          mkdir -p api
          cat > api/function.json << 'EOF'
          {
            "bindings": [
              {
                "authLevel": "anonymous",
                "type": "httpTrigger",
                "direction": "in",
                "name": "req",
                "methods": ["get", "post", "put", "delete", "patch", "options"],
                "route": "{*segments}"
              },
              {
                "type": "http",
                "direction": "out",
                "name": "res"
              }
            ],
            "scriptFile": "../function-wrapper.js"
          }
          EOF
          
          # Debug: Verify structure
          echo "Verifying function structure:"
          ls -la
          echo "Function directory contents:"
          ls -la api/
          echo "Checking function-wrapper.js:"
          ls -la function-wrapper.js
          
          # Create deployment package
          zip -r ../monet-api.zip .
          cd ../..
          
      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          files: |
            releases/monet-frontend.zip
            releases/monet-api.zip
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}