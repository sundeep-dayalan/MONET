name: Release MONET Platform
on:
  push:
    tags: ['v*']

jobs:
  build-and-release:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      
      - name: Setup Node.js & pnpm
        uses: actions/setup-node@v3
        with:
          node-version: '20'
      - run: npm install -g pnpm
      
      - name: Install dependencies
        run: pnpm install
        
      - name: Build packages
        run: pnpm build
          
      - name: Create combined deployment package
        run: |
          mkdir -p releases/api-deploy
          
          # Copy backend files (compiled JavaScript)
          echo "Copying backend files..."
          cp -r packages/core/dist/* releases/api-deploy/
          cp packages/core/package.json releases/api-deploy/
          
          # Copy frontend files to a subfolder
          echo "Copying frontend files..."
          mkdir -p releases/api-deploy/frontend
          cp -r packages/client/dist/* releases/api-deploy/frontend/
          
          cd releases/api-deploy
          sed -i.bak '/\"main\":/d' package.json || true
          
          # Install production dependencies
          npm install --production
          
          # Create host.json
          cat > host.json << 'EOF'
          {
            "version": "2.0",
            "extensionBundle": {
              "id": "Microsoft.Azure.Functions.ExtensionBundle",
              "version": "[4.*, 5.0.0)"
            },
            "functionTimeout": "00:05:00",
            "http": {
              "routePrefix": ""
            }
          }
          EOF
          
          # Create function directory and configuration
          mkdir -p app
          cat > app/function.json << 'EOF'
          {
            "bindings": [
              {
                "authLevel": "anonymous",
                "type": "httpTrigger",
                "direction": "in",
                "name": "req",
                "methods": ["get", "post", "put", "delete", "patch", "options"],
                "route": "{*segments}"
              },
              {
                "type": "http",
                "direction": "out",
                "name": "res"
              }
            ],
            "scriptFile": "../function-wrapper.js"
          }
          EOF
          
          # Verify structure
          echo "Deployment structure:"
          ls -la
          echo "Frontend files:"
          ls -la frontend/ | head -5
          echo "Function config:"
          ls -la app/
          
          # Create deployment package
          zip -r ../monet-api.zip .
          cd ../..
          
      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          files: |
            releases/monet-api.zip
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}